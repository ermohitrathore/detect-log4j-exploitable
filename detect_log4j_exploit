#!/bin/bash

proc=$(ps -eo pid,command 2>/dev/null | grep [j]ava | awk '{print $1}')
flag=false
for p in $proc; do
   log4j_jar=$(ls -l /proc/"$p"/fd/ 2>/dev/null| grep "log4j-core.*jar" | awk -F '->' '{print $2}' | sed 's/^[[:blank:]]*//g')
   if [ -f "$log4j_jar" ]; then
      pom_data=$(zip -sf "$log4j_jar" 2>/dev/null | grep "pom.xml"| sed 's/^[[:blank:]]*//g')
      jndi_class=$(zip -sf "$log4j_jar" 2>/dev/null | grep "JndiLookup.class"| sed 's/^[[:blank:]]*//g')
      if [ -n "$jndi_class" ]; then
          exp=$(unzip -p $log4j_jar $pom_data | grep -Pzo "<artifactId>log4j</artifactId>\s*<version>.+?</version>" | grep "version" | grep -v ">2.16.0<")
          if [ -n "$exp" ]; then
              flag=true
          fi
      fi
   fi
done
echo "Exploitable: $flag"
